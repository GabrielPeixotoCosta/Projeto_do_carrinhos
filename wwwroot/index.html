<!DOCTYPE html>
<html>
<head>
    <title>Sensor Data Monitor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1) ;
        }

        .data-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .data-box {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            text-align: center;
        }

        .value {
            font-weight: bold;
            color: #2196F3;
            font-size: 24px;
        }

        .label {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }

        .chart-container {
            margin-top: 20px;
            position: relative;
            height: 400px;
            width: 100%;
        }

        .timestamp {
            color: #666;
            font-size: 0.9em;
            text-align: center;
            margin-top: 10px;
        }

        .timestampC {
            color: #666;
            font-size: 0.9em;
            text-align: center;
            margin-top: 10px;
        }

        .timestampG {
            color: #666;
            font-size: 0.9em;
            text-align: center;
            margin-top: 10px;
        }

        /* Estilos para captura de imagens periódicas */
        .image-capture-container {
            margin-top: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .image-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .btn {
            padding: 8px 15px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn:hover {
            background-color: #0b7dda;
        }

        .btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .image-preview {
            width: 100%;
            max-height: 300px;
            border: 1px solid #ddd;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .image-preview img {
            max-width: 100%;
            max-height: 300px;
        }

        /* Estilos para controle do carrinho */
        .car-control-container {
            margin-top: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            text-align: center;
        }

        .control-grid {
            display: grid;
            grid-template-columns: repeat(3, 60px);
            grid-template-rows: repeat(3, 60px);
            gap: 5px;
            margin: 0 auto;
            width: fit-content;
        }

        .control-btn {
            width: 60px;
            height: 60px;
            font-size: 24px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .control-btn:hover {
            background-color: #0b7dda;
        }

        .control-btn:active {
            background-color: #0a6bc1;
        }

        .btn-up {
            grid-column: 2;
            grid-row: 1;
        }

        .btn-left {
            grid-column: 1;
            grid-row: 2;
        }

        .btn-stop {
            grid-column: 2;
            grid-row: 2;
            background-color: #f44336;
        }

        .btn-stop:hover {
            background-color: #d32f2f;
        }

        .btn-right {
            grid-column: 3;
            grid-row: 2;
        }

        .btn-down {
            grid-column: 2;
            grid-row: 3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Dados do Acelerômetro</h2>
        <div class="data-grid">
            <div class="data-box">
                <div class="value" id="xValue">0</div>
                <div class="label">X</div>
            </div>
            <div class="data-box">
                <div class="value" id="yValue">0</div>
                <div class="label">Y</div>
            </div>
            <div class="data-box">
                <div class="value" id="zValue">0</div>
                <div class="label">Z</div>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="accelerometerChart"></canvas>
        </div>
        <p class="timestamp">Última atualização: <span id="timestamp">...</span></p>

        <!-- Dados do Compass -->
        <h2>Dados do Compass</h2>
        <div class="data-grid">
            <div class="data-box">
                <div class="value" id="compassValue">0</div>
                <div class="label">Compass (°)</div>
            </div>
        </div>
        <p class="timestampC">Última atualização: <span id="timestampC">...</span></p>

        <!-- Dados do Gyroscope -->
        <h2>Dados do Giroscópio</h2>
        <div class="data-grid">
            <div class="data-box">
                <div class="value" id="gyroXValue">0</div>
                <div class="label">X (rad/s)</div>
            </div>
            <div class="data-box">
                <div class="value" id="gyroYValue">0</div>
                <div class="label">Y (rad/s)</div>
            </div>
            <div class="data-box">
                <div class="value" id="gyroZValue">0</div>
                <div class="label">Z (rad/s)</div>
            </div>
        </div>
        <p class="timestampG">Última atualização: <span id="timestampG">...</span></p>

        <!-- Nova seção para captura de imagens periódicas -->
        <h2>Captura de Imagens Periódicas</h2>
        <div class="image-capture-container">
            <div class="image-controls">
                <button id="start-capture-btn" class="btn">Iniciar Captura</button>
                <button id="stop-capture-btn" class="btn" disabled>Parar Captura</button>
                <label for="capture-interval">Intervalo (segundos):</label>
                <input type="number" id="capture-interval" min="1" max="60" value="5">
            </div>
            <h3>Última Imagem Capturada</h3>
            <div class="image-preview">
                <img id="captured-image" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNk+A8AAQUBAScY42YAAAAASUVORK5CYII=" alt="Nenhuma imagem capturada">
            </div>
            <p class="timestamp">Status: <span id="capture-status">Inativo</span></p>
        </div>

        <!-- Nova seção para controle do carrinho -->
        <h2>Controle de Carrinho</h2>
        <div class="car-control-container">
            <div class="control-grid">
                <button id="forward-btn" class="control-btn btn-up">▲</button>
                <button id="left-btn" class="control-btn btn-left">◄</button>
                <button id="stop-btn" class="control-btn btn-stop">■</button>
                <button id="right-btn" class="control-btn btn-right">►</button>
                <button id="backward-btn" class="control-btn btn-down">▼</button>
            </div>
            <p class="timestamp">Direção atual: <span id="direction-status">Parado</span></p>
        </div>

    </div>

    <script>
        let connection = null;
        const maxDataPoints = 50;
        let timeCounter = 0;
        let lastUpdateTime = null;
        let chartData = {
            labels: [],
            xData: [],
            yData: [],
            zData: []
        };

        // Configuração do gráfico
        const ctx = document.getElementById('accelerometerChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'X',
                        data: [],
                        borderColor: 'rgb(255, 99, 132)',
                        tension: 0.1
                    },
                    {
                        label: 'Y',
                        data: [],
                        borderColor: 'rgb(54, 162, 235)',
                        tension: 0.1
                    },
                    {
                        label: 'Z',
                        data: [],
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Tempo (s)'
                        }
                    },
                    y: {
                        beginAtZero: false
                    }
                },
                animation: {
                    duration: 0
                }
            }
        });

        function updateTimeCounter() {
            const currentTime = Date.now();
            if (lastUpdateTime === null) {
                lastUpdateTime = currentTime;
                timeCounter = 0;
            } else {
                timeCounter = (currentTime - lastUpdateTime) / 1000;
            }
            return timeCounter.toFixed(1);
        }

        function updateChart(x, y, z) {
            const currentTime = updateTimeCounter();

            // Adiciona novos dados
            chartData.labels.push(currentTime);
            chartData.xData.push(x);
            chartData.yData.push(y);
            chartData.zData.push(z);

            // Mantém apenas os últimos maxDataPoints pontos
            if (chartData.labels.length > maxDataPoints) {
                chartData.labels = chartData.labels.slice(-maxDataPoints);
                chartData.xData = chartData.xData.slice(-maxDataPoints);
                chartData.yData = chartData.yData.slice(-maxDataPoints);
                chartData.zData = chartData.zData.slice(-maxDataPoints);
            }

            // Atualiza o gráfico
            chart.data.labels = chartData.labels;
            chart.data.datasets[0].data = chartData.xData;
            chart.data.datasets[1].data = chartData.yData;
            chart.data.datasets[2].data = chartData.zData;
            chart.update();
        }

        // Variáveis para captura de imagens
        let captureInterval = null;
        const startCaptureBtn = document.getElementById('start-capture-btn');
        const stopCaptureBtn = document.getElementById('stop-capture-btn');
        const captureIntervalInput = document.getElementById('capture-interval');
        const capturedImage = document.getElementById('captured-image');
        const captureStatus = document.getElementById('capture-status');

        // Variáveis para controle do carrinho
        const forwardBtn = document.getElementById('forward-btn');
        const leftBtn = document.getElementById('left-btn');
        const stopBtn = document.getElementById('stop-btn');
        const rightBtn = document.getElementById('right-btn');
        const backwardBtn = document.getElementById('backward-btn');
        const directionStatus = document.getElementById('direction-status');
        
        // Inicializar eventos de controle do carrinho
        function initCarControls() {
            forwardBtn.addEventListener('click', () => sendCarCommand('forward'));
            leftBtn.addEventListener('click', () => sendCarCommand('left'));
            stopBtn.addEventListener('click', () => sendCarCommand('stop'));
            rightBtn.addEventListener('click', () => sendCarCommand('right'));
            backwardBtn.addEventListener('click', () => sendCarCommand('backward'));
            
            // Adicionar suporte para teclas de seta
            document.addEventListener('keydown', (e) => {
                switch(e.key) {
                    case 'ArrowUp':
                        sendCarCommand('forward');
                        break;
                    case 'ArrowLeft':
                        sendCarCommand('left');
                        break;
                    case 'ArrowDown':
                        sendCarCommand('backward');
                        break;
                    case 'ArrowRight':
                        sendCarCommand('right');
                        break;
                    case ' ': // Espaço
                        sendCarCommand('stop');
                        break;
                }
            });
        }
        
        // Enviar comando para o carrinho
        function sendCarCommand(direction) {
            if (connection && connection.state === signalR.HubConnectionState.Connected) {
                connection.invoke("SendCarCommand", { direction })
                    .then(() => {
                        directionStatus.textContent = direction.charAt(0).toUpperCase() + direction.slice(1);
                    })
                    .catch(err => {
                        console.error("Erro ao enviar comando:", err);
                    });
            } else {
                console.log("Não conectado ao servidor. Comando:", direction);
                directionStatus.textContent = direction.charAt(0).toUpperCase() + direction.slice(1) + " (offline)";
            }
        }
        
        // Inicializar eventos de captura de imagem
        function initImageCapture() {
            startCaptureBtn.addEventListener('click', startCapture);
            stopCaptureBtn.addEventListener('click', stopCapture);
        }
        
        // Iniciar captura periódica
        function startCapture() {
            const interval = parseInt(captureIntervalInput.value) || 5;
            
            // Solicitar permissão para a câmera
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                    const video = document.createElement('video');
                    video.srcObject = stream;
                    video.play();
                    
                    // Capturar primeira imagem
                    setTimeout(() => captureImage(video, stream), 500);
                    
                    // Configurar captura periódica
                    captureInterval = setInterval(() => captureImage(video, stream), interval * 1000);
                    
                    // Atualizar UI
                    startCaptureBtn.disabled = true;
                    stopCaptureBtn.disabled = false;
                    captureStatus.textContent = "Ativo";
                })
                .catch(err => {
                    console.error("Erro ao acessar câmera:", err);
                    captureStatus.textContent = "Erro: " + err.message;
                });
        }
        
        // Parar captura periódica
        function stopCapture() {
            if (captureInterval) {
                clearInterval(captureInterval);
                captureInterval = null;
            }
            
            // Atualizar UI
            startCaptureBtn.disabled = false;
            stopCaptureBtn.disabled = true;
            captureStatus.textContent = "Inativo";
        }
        
        // Capturar uma imagem da câmera
        function captureImage(video, stream) {
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Converter para base64
            const imageData = canvas.toDataURL('image/jpeg', 0.8);
            
            // Atualizar imagem na interface
            capturedImage.src = imageData;
            
            // Enviar para o servidor
            if (connection && connection.state === signalR.HubConnectionState.Connected) {
                connection.invoke("SendPeriodicImage", imageData)
                    .catch(err => {
                        console.error("Erro ao enviar imagem:", err);
                    });
            }
        }

        async function startConnection() {
            try {
                // NOTA: Para futura integração com Azure SignalR Service, use a URL abaixo:
                // const hubUrl = "https://seu-servico-signalr.service.signalr.net/sensordatahub";
                
                // Para testes locais, use o IP da sua máquina:
                const hubUrl = "https://192.168.100.13:5001/sensordatahub";
                
                connection = new signalR.HubConnectionBuilder() 
                    .withUrl(hubUrl)
                    .withAutomaticReconnect()
                    .build();

                connection.on("ReceiveAccelerometerData", (data) => {
                    // Atualiza os valores atuais
                    document.getElementById("xValue").textContent = data.x.toFixed(2);
                    document.getElementById("yValue").textContent = data.y.toFixed(2);
                    document.getElementById("zValue").textContent = data.z.toFixed(2);
                    document.getElementById("timestamp").textContent = new Date().toLocaleTimeString();

                    // Atualiza o gráfico
                    updateChart(data.x, data.y, data.z);
                });

                // Compass
                connection.on("ReceiveCompassData", (data) => {
                    document.getElementById("compassValue").textContent = data.c.toFixed(2);
                    document.getElementById("timestampC").textContent = new Date().toLocaleTimeString();
                });

                // Gyroscope
                connection.on("ReceiveGyroscopeData", (data) => {
                    document.getElementById("gyroXValue").textContent = data.x.toFixed(2);
                    document.getElementById("gyroYValue").textContent = data.y.toFixed(2);
                    document.getElementById("gyroZValue").textContent = data.z.toFixed(2);
                    document.getElementById("timestampG").textContent = new Date().toLocaleTimeString();
                });

                // Receber imagens periódicas de outros clientes
                connection.on("ReceivePeriodicImage", (imageData) => {
                    capturedImage.src = imageData;
                });

                await connection.start();
                console.log("SignalR Connected");
            } catch (err) {
                console.error("SignalR Connection Error: ", err);
                setTimeout(startConnection, 5000);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            startConnection();
            initCarControls();
            initImageCapture();
        });

        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && (!connection || connection.state === signalR.HubConnectionState.Disconnected)) {
                startConnection();
            }
        });
    </script>
</body>
</html>
